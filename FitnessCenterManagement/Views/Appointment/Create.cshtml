@model FitnessCenterManagement.Models.Appointment
@using FitnessCenterManagement.Models

@{
    ViewData["Title"] = "Yeni Randevu Oluştur";
}

<h1>Yeni Randevu Oluştur</h1>

<hr />
<div class="row">
    <div class="col-md-6">
        <form asp-action="Create" method="post">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>

            <div class="mb-3">
                <label asp-for="TrainerId" class="form-label">Antrenör</label>
                <select asp-for="TrainerId" class="form-control" id="TrainerId">
                    <option value="">-- Antrenör Seçin --</option>
                    @foreach (var trainer in (List<Trainer>)ViewBag.Trainers)
                    {
                        <option value="@trainer.Id">@trainer.FirstName @trainer.LastName - @trainer.Specialization.GetDisplayName()</option>
                    }
                </select>
                <span asp-validation-for="TrainerId" class="text-danger"></span>
            </div>

            <div class="mb-3">
                <label asp-for="ServiceId" class="form-label">Hizmet</label>
                <select asp-for="ServiceId" class="form-control">
                    <option value="">-- Hizmet Seçin --</option>
                    @foreach (var service in (List<Service>)ViewBag.Services)
                    {
                        <option value="@service.Id">@service.ServiceType.GetDisplayName() - @service.DurationMinutes dk - @service.Price ₺ (aylık)</option>
                    }
                </select>
                <span asp-validation-for="ServiceId" class="text-danger"></span>
            </div>

            <div class="mb-3">
                <label class="form-label">Randevu Tarihi</label>
                <input type="date" class="form-control" id="AppointmentDateOnly" />
                <span class="text-danger" id="dateError"></span>
            </div>

            <div class="mb-3">
                <label class="form-label">Randevu Saati</label>
                <select class="form-control" id="AppointmentTimeOnly">
                    <option value="">-- Önce antrenör ve tarih seçin --</option>
                </select>
                <span class="text-danger" id="timeError"></span>
                <small class="form-text text-muted">Müsait saatler otomatik olarak gösterilecektir.</small>
            </div>

            <!-- Gizli input - form submit edildiginde tarih ve saati birlestir -->
            <input type="hidden" asp-for="AppointmentDate" id="AppointmentDateHidden" />

            <div class="mb-3">
                <label asp-for="Notes" class="form-label">Notlar (Opsiyonel)</label>
                <textarea asp-for="Notes" class="form-control" rows="3"></textarea>
                <span asp-validation-for="Notes" class="text-danger"></span>
            </div>

            <div class="mb-3">
                <button type="submit" class="btn btn-success" id="submitBtn">Randevu Oluştur</button>
                <a asp-action="Index" class="btn btn-secondary">İptal</a>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        $(document).ready(function () {
            // Antrenor veya tarih degistiginde musait saatleri getir
            $('#TrainerId, #AppointmentDateOnly').change(function () {
                updateAvailableTimeSlots();
            });

            function updateAvailableTimeSlots() {
                var trainerId = $('#TrainerId').val();
                var date = $('#AppointmentDateOnly').val();

                if (trainerId && date) {
                    // Loading goster
                    $('#AppointmentTimeOnly').html('<option value="">Yükleniyor...</option>');

                    $.ajax({
                        url: '@Url.Action("GetAvailableTimeSlots", "Appointment")',
                        type: 'GET',
                        data: {
                            trainerId: trainerId,
                            date: date
                        },
                        success: function (data) {
                            var timeDropdown = $('#AppointmentTimeOnly');
                            timeDropdown.empty();

                            if (data.length === 0) {
                                timeDropdown.append('<option value="">Bu tarihte müsait saat yok</option>');
                            } else {
                                timeDropdown.append('<option value="">Saat seçiniz...</option>');
                                $.each(data, function (index, item) {
                                    timeDropdown.append($('<option></option>')
                                        .attr('value', item.value)
                                        .text(item.text));
                                });
                            }
                        },
                        error: function () {
                            var timeDropdown = $('#AppointmentTimeOnly');
                            timeDropdown.empty();
                            timeDropdown.append('<option value="">Hata! Tekrar deneyin.</option>');
                        }
                    });
                } else {
                    $('#AppointmentTimeOnly').html('<option value="">-- Önce antrenör ve tarih seçin --</option>');
                }
            }

            // Form submit edildiginde tarih ve saati birlestir
            $('form').submit(function (e) {
                var date = $('#AppointmentDateOnly').val();
                var time = $('#AppointmentTimeOnly').val();

                if (!date) {
                    e.preventDefault();
                    $('#dateError').text('Tarih seçimi zorunludur');
                    return false;
                }

                if (!time) {
                    e.preventDefault();
                    $('#timeError').text('Saat seçimi zorunludur');
                    return false;
                }

                // Tarih ve saati birlestir - datetime-local formatinda
                var dateTime = date + 'T' + time + ':00';
                $('#AppointmentDateHidden').val(dateTime);

                return true;
            });
        });
    </script>
}
